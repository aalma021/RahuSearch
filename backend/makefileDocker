# ------------------------------------------
# MAKEFILE (Docker + GPU Backend)
# ------------------------------------------

API_SERVICE := api
OS_SERVICE := opensearch

.PHONY: all up api logs stop reset build

# ------------------------------------------
# DEFAULT TARGET
# ------------------------------------------
all: build up api

# ------------------------------------------
# 1) Build Docker Image (API)
# ------------------------------------------
build:
	@echo ">>> Building API Docker image..."
	docker compose build $(API_SERVICE)

# ------------------------------------------
# 2) Start OpenSearch ONLY
# ------------------------------------------
up:
	@echo ">>> Starting OpenSearch..."
	docker compose up -d $(OS_SERVICE)

	@echo ">>> Waiting for OpenSearch to be ready..."

	@bash -c '\
	for i in {1..200}; do \
		if curl -s http://localhost:9200 >/dev/null; then \
			echo ">>> OpenSearch is ready!"; \
			exit 0; \
		fi; \
		echo ">>> Waiting for OpenSearch... ($$i/200)"; \
		sleep 1; \
	done; \
	echo ">>> ERROR: OpenSearch did NOT become ready in time!"; \
	exit 1;'

# ------------------------------------------
# 3) Start API Container (GPU ENABLED)
# ------------------------------------------
api:
	@echo ">>> Starting API with GPU support..."
	docker compose up -d --force-recreate api

# GPU ile “background’da” ayağa kaldırmak istersen:
# docker compose up -d api --build --force-recreate --gpus all

# ------------------------------------------
# 4) View Live Logs
# ------------------------------------------
logs:
	docker compose logs -f $(API_SERVICE)

# ------------------------------------------
# 5) Stop All Containers (Keep Data)
# ------------------------------------------
stop:
	@echo ">>> Stopping containers..."
	docker compose down

# ------------------------------------------
# 6) FULL RESET (Delete volumes)
# ------------------------------------------
reset:
	@echo ">>> WARNING: This will delete ALL OpenSearch data!"
	docker compose down -v
